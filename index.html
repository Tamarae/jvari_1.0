<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>იერუსალიმის ჯვრის მონასტრის აღაპები - პროსოპოგრაფიული მონაცემთა ბაზა</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
</head>
<body class="georgian">
    <div class="header">
        <div class="language-switch">
            <button class="lang-btn active" data-lang="ka">ქართული</button>
            <button class="lang-btn" data-lang="en">English</button>
        </div>
        <div class="header-content">
            <h1 class="georgian-main">იერუსალიმის ჯვრის მონასტრის აღაპები</h1>
            <div class="subtitle">Jerusalem Cross Monastery Commemorative Records</div>
            <div class="subtitle">XI–XVII Centuries</div>
            <div class="meta">Based on Leipzig MS V-1085 and Jerusalem MSS 24-25</div>
        </div>
    </div>

    <div class="container">
        <div class="tab-navigation">
            <div class="tab active" data-tab="home">
                <span class="lang-en">home</span>
                <span class="lang-ka georgian-main">მიმოხილვა</span>
            </div>
            <div class="tab" data-tab="prosopography">
                <span class="lang-en">Prosopography</span>
                <span class="lang-ka georgian-main">პროსოპოგრაფია</span>
            </div>
            <div class="tab" data-tab="sources">
                <span class="lang-en">Sources</span>
                <span class="lang-ka georgian-main">ტექსტი</span>
            </div>
            <div class="tab" data-tab="research">
                <span class="lang-en">Research</span>
                <span class="lang-ka georgian-main">კვლევა</span>
            </div>
        </div>

        <div id="home-content" class="tab-content active">
            <div class="dashboard">
                <div class="stats-panel">
                    <h3 class="lang-en">Database Overview</h3>
                    <h3 class="lang-ka georgian-main">ბაზის მიმოხილვა</h3>
                    <div id="databaseOverview"></div>
                </div>
                <div class="network-viz">
                    <h3 class="lang-en">Social Network Graph</h3>
                    <h3 class="lang-ka georgian-main">სოციალური ქსელი</h3>
                    <iframe src="prosopographical-network.html" width="100%" height="700" frameborder="0" style="border: 1px solid #ddd; border-radius: 4px;"></iframe>
                </div>
                <div class="stats-panel">
                    <h3 class="lang-en">Economic Data</h3>
                    <h3 class="lang-ka georgian-main">ეკონომიკური მონაცემები</h3>
                    <div id="economicStats"></div>
                </div>
            </div>
        </div>

        <div id="prosopography-content" class="tab-content">
            <div class="search-panel">
                <div class="search-grid">
                    <input type="text" class="search-input lang-en" id="searchInput" placeholder="Search by name">
                    <input type="text" class="search-input lang-ka georgian-main" id="searchInputKa" placeholder="ძიება სახელით">
                    <select class="search-select lang-en" id="familySelect">
                        <option value="">All Families</option>
                    </select>
                    <select class="search-select lang-ka georgian-main" id="familySelectKa">
                        <option value="">ყველა ოჯახი</option>
                    </select>
                    <select class="search-select lang-en" id="roleSelect">
                        <option value="">All Social Classes</option>
                    </select>
                    <select class="search-select lang-ka georgian-main" id="roleSelectKa">
                        <option value="">ყველა სოციალური კლასი</option>
                    </select>
                </div>
            </div>
            <div id="searchResultsInfo" class="search-results-info" style="display: none;"></div>
            <div class="view-controls">
                <div class="view-switcher">
                    <button id="view-card-btn" class="view-btn active" title="Card View">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zm8 0A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm-8 8A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm8 0A1.5 1.5 0 0 1 10.5 9h3A1.5 1.5 0 0 1 15 10.5v3A1.5 1.5 0 0 1 13.5 15h-3A1.5 1.5 0 0 1 9 13.5v-3z"/></svg>
                    </button>
                    <button id="view-list-btn" class="view-btn" title="List View">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/></svg>
                    </button>
                </div>
                <div class="sort-controls">
                    <select id="sortSelect" class="search-select">
                        <option value="name_asc" class="lang-en">Sort by Name (A-Z)</option>
                        <option value="name_asc" class="lang-ka georgian-main">დალაგება სახელით (ა-ჰ)</option>
                        <option value="name_desc" class="lang-en">Sort by Name (Z-A)</option>
                        <option value="name_desc" class="lang-ka georgian-main">დალაგება სახელით (ჰ-ა)</option>
                        <option value="mentions_desc" class="lang-en">Sort by Mentions (High to Low)</option>
                        <option value="mentions_desc" class="lang-ka georgian-main">დალაგება ხსენებების რაოდენობით (კლებადი)</option>
                    </select>
                </div>
            </div>
            <div class="main-content card-view" id="mainContent"></div>
        </div>

        <div id="sources-content" class="tab-content">
            <div class="sources-viewer">
                <div class="item-index-panel">
                    <h3 class="panel-header lang-ka georgian-main">სარჩევი</h3>
                    <h3 class="panel-header lang-en">Table of Contents</h3>
                    <div id="sources-list-new"></div>
                </div>
                <div class="manuscript-info-panel">
                    <div class="manuscript-header">
                        <h3 class="panel-header lang-ka georgian-main">ხელნაწერის აღწერა</h3>
                        <h3 class="panel-header lang-en">Manuscript Description</h3>
                        <p><strong>Leipzig University Library, MS V-1085</strong></p>
                        <p class="lang-ka georgian-main">ეს ხელნაწერი შეიცავს იერუსალიმის ჯვრის მონასტრის უძველეს აღაპებს, რომლებიც XI–XVII საუკუნეებით თარიღდება.</p>
                        <p class="lang-en">This manuscript contains the oldest commemorative records (agapes) from the Monastery of the Cross in Jerusalem, dating from the 11th to the 17th centuries.</p>
                    </div>
                    <div class="legend-section">
                        <h3 class="panel-header lang-ka georgian-main">ნიშნების განმარტება</h3>
                        <h3 class="panel-header lang-en">Explanation of Signs</h3>
                        <ul>
                            <li><strong>Bold Text:</strong> Person, place, or organization.</li>
                            <li><em>Italic Text:</em> Liturgical term or date.</li>
                            <li>[...]: Reconstructed or supplied text.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="research-content" class="tab-content">
            <!-- Your original research content structure can be pasted back here if needed -->
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    // --- STATE & DATA VARIABLES ---
    let database = {};
    let filteredPersons = [];
    let currentView = 'card';
    let currentSort = 'name_asc';

    // --- UI ELEMENT REFERENCES ---
    const mainContent = document.getElementById('mainContent');
    const sourcesListContainer = document.getElementById('sources-list-new');

    // --- DATA FETCHING (Single, unified block) ---
    fetch('database.json')
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            database = data;
            // Kick off the entire page setup now that we have the data
            initializePage();
        })
        .catch(error => {
            console.error("Fatal Error: Could not load or parse database.json.", error);
            document.body.innerHTML = '<div style="padding: 2rem; text-align: center;"><h1>Error</h1><p>Could not load the project database. Please check the console for details.</p></div>';
        });

    // --- INITIALIZATION ---
    function initializePage() {
        if (!database) return;
        filteredPersons = [...(database.persons || [])];

        populateDatabaseOverview(database.stats);
        populateEconomicStats(database.stats);
        populateFilters();
        renderSources();
        setupEventListeners();
        performFilterAndRender(); // Perform initial sort and render
        handleLanguageSwitch(document.body.classList.contains('english') ? 'en' : 'ka');
    }

    // --- RENDER FUNCTIONS ---
    function renderResults() {
        if (!mainContent) return;
        sortPersons(); // Always sort before rendering

        const isGeorgian = !document.body.classList.contains('english');

        if (currentView === 'card') {
            mainContent.className = 'main-content card-view';
            mainContent.innerHTML = filteredPersons.map(person => {
                const badgeText = getPrimaryRoleLabel(person.primaryRole, isGeorgian);
                return `
                <a href="pages/person/${person.id}.html" class="person-card" data-person-id="${person.id}">
                    <div class="person-name">${isGeorgian ? person.nameKa : person.nameEn}</div>
                    <div class="status-badge" data-role="${person.primaryRole}">${badgeText}</div>
                    <div class="mention-count">${person.sourcesDisplay}</div>
                </a>`;
            }).join('');
        } else { // List view
            mainContent.className = 'main-content list-view';
            const headerHTML = `
                <div class="person-list-item header-row">
                    <div class="person-name"><span class="lang-ka georgian-main">პირი</span><span class="lang-en">Person</span></div>
                    <div class="person-list-details"><span class="lang-ka georgian-main">სოციალური სტატუსი</span><span class="lang-en">Social Status</span></div>
                    <div class="status-badge"><span class="lang-ka georgian-main">როლი</span><span class="lang-en">Role</span></div>
                    <div class="mention-count"><span class="lang-ka georgian-main">ხელნაწერში</span><span class="lang-en">In Manuscript</span></div>
                </div>`;
            const listItemsHTML = filteredPersons.map(person => {
                const detailsText = getCategoryLabel(person.roleCategory, isGeorgian);
                const badgeText = getPrimaryRoleLabel(person.primaryRole, isGeorgian);
                return `
                <a href="pages/person/${person.id}.html" class="person-list-item" data-person-id="${person.id}">
                    <div class="person-name">${isGeorgian ? person.nameKa : person.nameEn}</div>
                    <div class="person-list-details">${detailsText}</div>
                    <div class="status-badge" data-role="${person.primaryRole}">${badgeText}</div>
                    <div class="mention-count">${person.sourcesDisplay}</div>
                </a>`;
            }).join('');
            mainContent.innerHTML = headerHTML + listItemsHTML;
        }
    }

    function renderSources() {
        if (!sourcesListContainer || !database.sources) return;
        const groupedSources = d3.group(database.sources, d => d.source);
        let html = '';
        groupedSources.forEach((items, sourceName) => {
            html += `<div class="source-group expanded">`;
            html += `<div class="source-group-header">${sourceName || 'Uncategorized'}</div>`;
            html += `<div class="source-item-list">${items.map(item => `
                <a href="pages/item/${item.id}.html">
                    <span class="source-list-item-number">[${item.number}]</span>
                    <span class="lang-ka georgian-main">${item.titleKa || 'უსათაურო'}</span>
                    <span class="lang-en">${item.titleEn || 'Untitled'}</span>
                </a>`).join('')}</div></div>`;
        });
        sourcesListContainer.innerHTML = html;
    }

    // --- POPULATE UI FUNCTIONS ---
    function populateDatabaseOverview(stats) {
        if (!stats) return;
        const container = document.getElementById('databaseOverview');
        if (!container) return;
        let html = '';
        if (stats.totalPersons) html += `<div class="stat-item"><span class="lang-en">Total Unique Persons</span><span class="lang-ka georgian-main">სულ უნიკალური პირი</span><span class="stat-value">${stats.totalPersons}</span></div>`;
        if (stats.totalFamilies) html += `<div class="stat-item"><span class="lang-en">Total Unique Families</span><span class="lang-ka georgian-main">სულ უნიკალური გვარი</span><span class="stat-value">${stats.totalFamilies}</span></div>`;
        if (stats.roleCounts?.length > 0) {
            html += '<hr style="border: none; border-top: 1px solid #eee; margin: 1rem 0;">';
            stats.roleCounts.forEach(role => {
                html += `<div class="stat-item"><span class="lang-en">${role.displayEn}</span><span class="lang-ka georgian-main">${role.displayKa}</span><span class="stat-value">${role.count}</span></div>`;
            });
        }
        container.innerHTML = html;
    }

    function populateEconomicStats(stats) {
        if (!stats) return;
        const container = document.getElementById('economicStats');
        if (!container) return;
        let html = '';
        if (stats.totalFlorins > 0) html += `<div class="stat-item"><span class="lang-en">Total Florins Mentioned</span><span class="lang-ka georgian-main">ჯამური ფლური</span><span class="stat-value">${stats.totalFlorins}</span></div>`;
        if (stats.totalTetri > 0) html += `<div class="stat-item"><span class="lang-en">Total Tetri Mentioned</span><span class="lang-ka georgian-main">ჯამური თეთრი</span><span class="stat-value">${stats.totalTetri}</span></div>`;
        if (html === '') html = `<div class="stat-item"><span class="lang-en">No specific coin amounts found.</span><span class="lang-ka georgian-main">კონკრეტული მონეტები არ მოიძებნა.</span></div>`;
        container.innerHTML = html;
    }

    function populateFilters() {
        const familySelect = document.getElementById('familySelect');
        const familySelectKa = document.getElementById('familySelectKa');
        if (familySelect && familySelectKa && database.families) {
            let options = '<option value="">All Families</option>' + (database.families.map(f => `<option value="${f.key}">${f.display}</option>`).join(''));
            familySelect.innerHTML = options;
            familySelectKa.innerHTML = options.replace('All Families', 'ყველა ოჯახი');
        }
        const roleSelect = document.getElementById('roleSelect');
        const roleSelectKa = document.getElementById('roleSelectKa');
        if (roleSelect && roleSelectKa && database.roleCategories) {
            let optionsEn = '<option value="">All Social Classes</option>';
            let optionsKa = '<option value="">ყველა სოციალური კლასი</option>';
            database.roleCategories.forEach(cat => {
                optionsEn += `<option value="${cat.key}">${cat.displayEn}</option>`;
                optionsKa += `<option value="${cat.key}">${cat.displayKa}</option>`;
            });
            roleSelect.innerHTML = optionsEn;
            roleSelectKa.innerHTML = optionsKa;
        }
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', function() {
            document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab + '-content').classList.add('active');
        }));
        document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', () => handleLanguageSwitch(btn.dataset.lang)));
        document.getElementById('searchInput')?.addEventListener('input', performFilterAndRender);
        document.getElementById('searchInputKa')?.addEventListener('input', performFilterAndRender);
        document.getElementById('familySelect')?.addEventListener('change', e => syncAndFilter('familySelectKa', e.target.value));
        document.getElementById('familySelectKa')?.addEventListener('change', e => syncAndFilter('familySelect', e.target.value));
        document.getElementById('roleSelect')?.addEventListener('change', e => syncAndFilter('roleSelectKa', e.target.value));
        document.getElementById('roleSelectKa')?.addEventListener('change', e => syncAndFilter('roleSelect', e.target.value));
        document.getElementById('view-card-btn')?.addEventListener('click', () => setView('card'));
        document.getElementById('view-list-btn')?.addEventListener('click', () => setView('list'));
        document.getElementById('sortSelect')?.addEventListener('change', e => { currentSort = e.target.value; renderResults(); });
        sourcesListContainer?.addEventListener('click', e => {
            if (e.target.classList.contains('source-group-header')) e.target.parentElement.classList.toggle('expanded');
        });
    }

    // --- DATA PROCESSING & FILTERING ---
    function performFilterAndRender() {
        const searchTermKa = document.getElementById('searchInputKa').value.toLowerCase();
        const searchTermEn = document.getElementById('searchInput').value.toLowerCase();
        const selectedFamily = document.getElementById('familySelect').value;
        const selectedRole = document.getElementById('roleSelect').value;
        filteredPersons = (database.persons || []).filter(p => {
            const nameMatch = (p.nameKa || '').toLowerCase().includes(searchTermKa) && (p.nameEn || '').toLowerCase().includes(searchTermEn);
            const familyMatch = !selectedFamily || p.familyKey === selectedFamily;
            const roleMatch = !selectedRole || p.roleCategory === selectedRole;
            return nameMatch && familyMatch && roleMatch;
        });
        renderResults();
    }

    function sortPersons() {
        const nameKey = document.body.classList.contains('english') ? 'nameEn' : 'nameKa';
        const locale = document.body.classList.contains('english') ? 'en-US' : 'ka';
        if (currentSort === 'mentions_desc') {
            filteredPersons.sort((a, b) => (b.items?.length || 0) - (a.items?.length || 0));
        } else if (currentSort === 'name_desc') {
            filteredPersons.sort((a, b) => (b[nameKey] || '').localeCompare(a[nameKey] || '', locale));
        } else { // name_asc
            filteredPersons.sort((a, b) => (a[nameKey] || '').localeCompare(b[nameKey] || '', locale));
        }
    }

    // --- UTILITY FUNCTIONS ---
    function syncAndFilter(targetId, value) { document.getElementById(targetId).value = value; performFilterAndRender(); }
    function setView(view) { currentView = view; renderResults(); }
    function handleLanguageSwitch(lang) {
        document.body.classList.toggle('english', lang === 'en');
        document.querySelectorAll('.lang-btn').forEach(b => { b.classList.toggle('active', b.dataset.lang === lang); });
        renderResults();
        renderSources(); // Re-render sources to apply language-specific visibility
    }
    function getPrimaryRoleLabel(role, isGeorgian) {
        const labels = {'donor': ['შემომწირველი', 'Donor'],'scribe': ['გადამწერი', 'Scribe'],'commemorated': ['მოხსენიებული', 'Commemorated']};
        return (labels[role] || [role, role])[isGeorgian ? 0 : 1];
    }
    function getCategoryLabel(category, isGeorgian) {
        const found = (database.roleCategories || []).find(c => c.key === category);
        return found ? (isGeorgian ? found.displayKa : found.displayEn) : category;
    }
});
</script>

</body>
</html>
