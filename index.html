<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>იერუსალიმის ჯვრის მონასტრის აღაპები - პროსოპოგრაფიული მონაცემთა ბაზა</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
</head>
<body class="georgian">
    <div class="header">
        <div class="language-switch">
            <button class="lang-btn active" data-lang="ka">ქართული</button>
            <button class="lang-btn" data-lang="en">English</button>
        </div>
        <div class="header-content">
            <h1 class="georgian-main">იერუსალიმის ჯვრის მონასტრის აღაპები</h1>
            <div class="subtitle">Jerusalem Cross Monastery Commemorative Records</div>
            <div class="subtitle">XI–XVII Centuries</div>
            <div class="meta">Based on Leipzig MS V-1085 and Jerusalem MSS 24-25</div>
        </div>
    </div>

    <div class="container">
        <div class="tab-navigation">
            <div class="tab active" data-tab="home">
                <span class="lang-en">home</span>
                <span class="lang-ka georgian-main">მიმოხილვა</span>
            </div>
            <div class="tab" data-tab="prosopography">
                <span class="lang-en">Prosopography</span>
                <span class="lang-ka georgian-main">პროსოპოგრაფია</span>
            </div>
            <div class="tab" data-tab="sources">
                <span class="lang-en">Sources</span>
                <span class="lang-ka georgian-main">ტექსტი</span>
            </div>
            <div class="tab" data-tab="research">
                <span class="lang-en">Research</span>
                <span class="lang-ka georgian-main">კვლევა</span>
            </div>
        </div>

        <div id="home-content" class="tab-content active">
            <div class="dashboard">
                <div class="stats-panel">
                    <h3 class="lang-en">Database Overview</h3>
                    <h3 class="lang-ka georgian-main">ბაზის მიმოხილვა</h3>
                    <div id="databaseStats"></div>
                </div>
                <div class="network-viz">
                    <h3 class="lang-en">Social Network Graph</h3>
                    <h3 class="lang-ka georgian-main">სოციალური ქსელი</h3>
                    <iframe src="prosopographical-network.html" width="100%" height="700" frameborder="0" style="border: 1px solid #ddd; border-radius: 4px;"></iframe>
                </div>
                <div class="stats-panel">
                    <h3 class="lang-en">Economic Data</h3>
                    <h3 class="lang-ka georgian-main">ეკონომიკური მონაცემები</h3>
                    <div id="economicStats"></div>
                </div>
            </div>
        </div>

        <div id="prosopography-content" class="tab-content">
            <div class="search-panel">
                <div class="search-grid">
                    <input type="text" class="search-input lang-en" id="searchInput" placeholder="Search by name">
                    <input type="text" class="search-input lang-ka georgian-main" id="searchInputKa" placeholder="ძიება სახელით">
                    <select class="search-select lang-en" id="familySelect">
                        <option value="">All Families</option>
                    </select>
                    <select class="search-select lang-ka georgian-main" id="familySelectKa">
                        <option value="">ყველა ოჯახი</option>
                    </select>
                    <select class="search-select lang-en" id="roleSelect">
                        <option value="">All Social Classes</option>
                    </select>
                    <select class="search-select lang-ka georgian-main" id="roleSelectKa">
                        <option value="">ყველა სოციალური კლასი</option>
                    </select>
                </div>
            </div>
            <div id="searchResultsInfo" class="search-results-info" style="display: none;"></div>
            <div class="view-controls">
                <div class="view-switcher">
                    <button id="view-card-btn" class="view-btn active" title="Card View">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zm8 0A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm-8 8A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm8 0A1.5 1.5 0 0 1 10.5 9h3A1.5 1.5 0 0 1 15 10.5v3A1.5 1.5 0 0 1 13.5 15h-3A1.5 1.5 0 0 1 9 13.5v-3z"/></svg>
                    </button>
                    <button id="view-list-btn" class="view-btn" title="List View">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/></svg>
                    </button>
                </div>
                <div class="sort-controls">
                    <select id="sortSelect" class="search-select">
                        <option value="name_asc" class="lang-en">Sort by Name (A-Z)</option>
                        <option value="name_asc" class="lang-ka georgian-main">დალაგება სახელით (ა-ჰ)</option>
                        <option value="name_desc" class="lang-en">Sort by Name (Z-A)</option>
                        <option value="name_desc" class="lang-ka georgian-main">დალაგება სახელით (ჰ-ა)</option>
                        <option value="mentions_desc" class="lang-en">Sort by Mentions (High to Low)</option>
                        <option value="mentions_desc" class="lang-ka georgian-main">დალაგება ხსენებების რაოდენობით (კლებადი)</option>
                    </select>
                </div>
            </div>
            <div class="main-content card-view" id="mainContent"></div>
        </div>

        <div id="sources-content" class="tab-content">
            <div class="sources-viewer">
                <div class="item-index-panel">
                    <h3 class="panel-header lang-ka georgian-main">სარჩევი</h3>
                    <h3 class="panel-header lang-en">Table of Contents</h3>
                    <div id="sources-list-new"></div>
                </div>
                <div class="manuscript-info-panel">
                    <div class="manuscript-header">
                        <h3 class="panel-header lang-ka georgian-main">ხელნაწერის აღწერა</h3>
                        <h3 class="panel-header lang-en">Manuscript Description</h3>
                        <p><strong>Leipzig University Library, MS V-1085</strong></p>
                        <p class="lang-ka georgian-main">ეს ხელნაწერი შეიცავს იერუსალიმის ჯვრის მონასტრის უძველეს აღაპებს, რომლებიც XI–XVII საუკუნეებით თარიღდება.</p>
                        <p class="lang-en">This manuscript contains the oldest commemorative records (agapes) from the Monastery of the Cross in Jerusalem, dating from the 11th to the 17th centuries.</p>
                    </div>
                    <div class="legend-section">
                        <h3 class="panel-header lang-ka georgian-main">ნიშნების განმარტება</h3>
                        <h3 class="panel-header lang-en">Explanation of Signs</h3>
                        <ul>
                            <li><strong>Bold Text:</strong> Person, place, or organization.</li>
                            <li><em>Italic Text:</em> Liturgical term or date.</li>
                            <li>[...]: Reconstructed or supplied text.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="research-content" class="tab-content">
            <!-- Your original research content structure can be pasted back here if needed -->
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- STATE & DATA VARIABLES ---
    let database = { persons: [], sources: [], families: [], roleCategories: [] };
    let filteredPersons = [];
    let currentView = 'card';
    let currentSort = 'name_asc';

    // --- UI ELEMENT REFERENCES ---
    const mainContent = document.getElementById('mainContent');
    const sourcesListContainer = document.getElementById('sources-list-new');

    // --- DATA FETCHING ---
    fetch('database.json')
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            database = {
                persons: data.persons || [],
                sources: data.sources || [],
                families: data.families || [],
                roleCategories: data.roleCategories || []
            };
            filteredPersons = [...database.persons];
            initializePage();
        })
        .catch(error => console.error("Could not load database.json:", error));

    // --- INITIALIZATION ---
    function initializePage() {
        populateStatistics();
        populateFilters();
        setupEventListeners();
        performFilterAndRender();
        renderSources();
        handleLanguageSwitch(document.body.classList.contains('english') ? 'en' : 'ka');
    }

    // --- RENDER FUNCTIONS ---
    function renderResults() {
        const isGeorgian = !document.body.classList.contains('english');

        if (currentView === 'card') {
            mainContent.innerHTML = filteredPersons.map(person => {
                if (!person) return '';
                let details = [];
                if (person.familyKey) details.push(`<strong>${isGeorgian ? 'ოჯახი:' : 'Family:'}</strong> ${person.familyKey}`);
                if (person.roleKey) details.push(`<strong>${isGeorgian ? 'წოდება:' : 'Title:'}</strong> ${person.roleKey}`);
                const detailsHTML = details.length > 0 ? `<div class="person-details">${details.join(' | ')}</div>` : '';
                const badgeText = getPrimaryRoleLabel(person.primaryRole, isGeorgian);

                return `
                <div class="person-card" data-person-id="${person.id}">
                    <div class="person-name">${isGeorgian ? person.nameKa : person.nameEn}</div>
                    ${detailsHTML}
                    <div class="status-badge" data-role="${person.primaryRole}">${badgeText}</div>
                    <div class="source-display"><strong>${isGeorgian ? 'წყაროები:' : 'Sources:'}</strong> ${person.sourcesDisplay}</div>
                </div>`;
            }).join('');
        } else { // List view
            const headerHTML = `
                <div class="person-list-item header-row">
                    <div class="person-name"><span class="lang-ka georgian-main">პირი</span><span class="lang-en">Person</span></div>
                    <div class="person-list-details"><span class="lang-ka georgian-main">სოციალური სტატუსი</span><span class="lang-en">Social Status</span></div>
                    <div class="status-badge"><span class="lang-ka georgian-main">როლი</span><span class="lang-en">Role</span></div>
                    <div class="mention-count"><span class="lang-ka georgian-main">ხელნაწერში</span><span class="lang-en">In Manuscript</span></div>
                </div>`;

            const listItemsHTML = filteredPersons.map(person => {
                if (!person) return '';
                const detailsText = getCategoryLabel(person.roleCategory, isGeorgian);
                const badgeText = getPrimaryRoleLabel(person.primaryRole, isGeorgian);

                return `
                <a href="#" class="person-list-item" data-person-id="${person.id}">
                    <div class="person-name">${isGeorgian ? person.nameKa : person.nameEn}</div>
                    <div class="person-list-details">${detailsText}</div>
                    <div class="status-badge" data-role="${person.primaryRole}">${badgeText}</div>
                    <div class="mention-count">${person.sourcesDisplay}</div>
                </a>`;
            }).join('');
            mainContent.innerHTML = headerHTML + listItemsHTML;
        }
    }

    function renderSources() {
        if (!database.sources.length || !sourcesListContainer) return;
        const groupedSources = d3.group(database.sources, d => d.source);

        let html = '';
        let isFirstGroup = true;
        for (const [sourceName, items] of groupedSources.entries()) {
            const expandedClass = isFirstGroup ? 'expanded' : '';
            html += `<div class="source-group ${expandedClass}">`;
            html += `<div class="source-group-header">${sourceName || 'Uncategorized'}</div>`;
            html += `<div class="source-item-list">`;
            html += items.map(item => {
                const titleKa = item.titleKa || 'უსათაურო';
                const titleEn = item.titleEn || 'Untitled';
                return `
                    <a href="pages/item/${item.id}.html">
                        <span class="source-list-item-number">[${item.number}]</span>
                        <span class="lang-ka georgian-main">${titleKa}</span>
                        <span class="lang-en">${titleEn}</span>
                    </a>`;
            }).join('');
            html += `</div></div>`;
            isFirstGroup = false;
        }
        sourcesListContainer.innerHTML = html;

        sourcesListContainer.querySelectorAll('.source-group-header').forEach(header => {
            header.addEventListener('click', function() {
                this.parentElement.classList.toggle('expanded');
            });
        });
    }

    // --- DATA PROCESSING & FILTERING ---
    function performFilterAndRender() {
        const searchTermKa = document.getElementById('searchInputKa').value.toLowerCase();
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const selectedFamily = document.getElementById('familySelect').value;
        const selectedRole = document.getElementById('roleSelect').value;

        filteredPersons = database.persons.filter(person => {
            if (!person) return false;
            const nameKa = (person.nameKa || '').toLowerCase();
            const nameEn = (person.nameEn || '').toLowerCase();
            const nameMatch = nameKa.includes(searchTermKa) && nameEn.includes(searchTerm);
            const familyMatch = selectedFamily ? person.familyKey === selectedFamily : true;
            const roleMatch = selectedRole ? person.roleCategory === selectedRole : true;
            return nameMatch && familyMatch && roleMatch;
        });
        sortPersons();
        renderResults();
    }

    function sortPersons() {
        const isGeorgian = !document.body.classList.contains('english');
        const nameKey = isGeorgian ? 'nameKa' : 'nameEn';
        const locale = isGeorgian ? 'ka' : 'en-US';
        if (currentSort === 'mentions_desc') {
            filteredPersons.sort((a, b) => (b.items?.length || 0) - (a.items?.length || 0));
        } else if (currentSort === 'name_desc') {
            filteredPersons.sort((a, b) => (b[nameKey] || '').localeCompare(a[nameKey] || '', locale));
        } else {
            filteredPersons.sort((a, b) => (a[nameKey] || '').localeCompare(a[nameKey] || '', locale));
        }
    }

    // --- POPULATE UI & EVENT LISTENERS ---
    function populateStatistics() {
        const dbStatsContainer = document.getElementById('databaseStats');
        if (dbStatsContainer) dbStatsContainer.innerHTML = `
            <div class="stat-item"><span class="lang-ka georgian-main">სულ პირი</span><span class="lang-en">Total Persons</span><span class="stat-value">${database.persons.length}</span></div>
            <div class="stat-item"><span class="lang-ka georgian-main">სულ ჩანაწერი</span><span class="lang-en">Total Items</span><span class="stat-value">${database.sources.length}</span></div>`;
    }

    function populateFilters() {
        const familySelect = document.getElementById('familySelect');
        const familySelectKa = document.getElementById('familySelectKa');
        if (familySelect && familySelectKa) {
            const currentVal = familySelect.value;
            familySelect.innerHTML = '<option value="">All Families</option>';
            familySelectKa.innerHTML = '<option value="">ყველა ოჯახი</option>';
            (database.families || []).forEach(family => {
                familySelect.innerHTML += `<option value="${family.key}">${family.display}</option>`;
                familySelectKa.innerHTML += `<option value="${family.key}">${family.display}</option>`;
            });
            familySelect.value = currentVal;
            familySelectKa.value = currentVal;
        }

        const roleSelect = document.getElementById('roleSelect');
        const roleSelectKa = document.getElementById('roleSelectKa');
        if (roleSelect && roleSelectKa) {
            const currentVal = roleSelect.value;
            roleSelect.innerHTML = '<option value="">All Social Classes</option>';
            roleSelectKa.innerHTML = '<option value="">ყველა სოციალური კლასი</option>';
            (database.roleCategories || []).forEach(cat => {
                roleSelect.innerHTML += `<option value="${cat.key}">${cat.displayEn}</option>`;
                roleSelectKa.innerHTML += `<option value="${cat.key}">${cat.displayKa}</option>`;
            });
            roleSelect.value = currentVal;
            roleSelectKa.value = currentVal;
        }
    }

    function setupEventListeners() {
        mainContent.addEventListener('click', event => {
            const targetElement = event.target.closest('.person-list-item:not(.header-row), .person-card');
            if (targetElement && targetElement.dataset.personId) {
                event.preventDefault();
                openPersonPage(targetElement.dataset.personId);
            }
        });
        document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
        }));
        document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', () => handleLanguageSwitch(btn.dataset.lang)));
        document.getElementById('searchInput')?.addEventListener('input', performFilterAndRender);
        document.getElementById('searchInputKa')?.addEventListener('input', performFilterAndRender);
        document.getElementById('familySelect')?.addEventListener('change', e => syncAndFilter('familySelectKa', e.target.value));
        document.getElementById('familySelectKa')?.addEventListener('change', e => syncAndFilter('familySelect', e.target.value));
        document.getElementById('roleSelect')?.addEventListener('change', e => syncAndFilter('roleSelectKa', e.target.value));
        document.getElementById('roleSelectKa')?.addEventListener('change', e => syncAndFilter('roleSelect', e.target.value));
        document.getElementById('view-card-btn').addEventListener('click', () => setView('card'));
        document.getElementById('view-list-btn').addEventListener('click', () => setView('list'));
        document.getElementById('sortSelect').addEventListener('change', e => {
            currentSort = e.target.value;
            performFilterAndRender();
        });
    }

    // --- UTILITY FUNCTIONS ---
    function syncAndFilter(targetId, value) {
        document.getElementById(targetId).value = value;
        performFilterAndRender();
    }
    function setView(view) {
        currentView = view;
        document.getElementById('mainContent').className = `main-content ${view}-view`;
        document.getElementById('view-card-btn').classList.toggle('active', view === 'card');
        document.getElementById('view-list-btn').classList.toggle('active', view === 'list');
        renderResults();
    }
    function handleLanguageSwitch(lang) {
        document.body.classList.toggle('english', lang !== 'ka');
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.lang-btn[data-lang="${lang}"]`).classList.add('active');
        populateFilters();
        sortPersons();
        renderResults();
    }

    function getPrimaryRoleLabel(role, isGeorgian) {
        if (!role) return '';
        const labels = {
            'donor': isGeorgian ? 'შემომწირველი' : 'Donor',
            'scribe': isGeorgian ? 'გადამწერი' : 'Scribe',
            'commemorated': isGeorgian ? 'მოხსენიებული' : 'Commemorated'
        };
        return labels[role] || role;
    }

    function getCategoryLabel(category, isGeorgian) {
        if (!category) return '';
        const labels = {
            'royal': isGeorgian ? 'მონარქი' : 'Royal',
            'noble': isGeorgian ? 'დიდებული' : 'Noble',
            'clergy': isGeorgian ? 'სასულიერო' : 'Clergy',
            'administrative': isGeorgian ? 'მოხელე' : 'Administrative',
            'secular': isGeorgian ? 'საერო' : 'Secular'
        };
        return labels[category] || category;
    }

    function openPersonPage(personId) {
        const filename = personId.toLowerCase();
        window.location.href = `pages/person/${filename}.html`;
    }
});
</script>

</body>
</html>
